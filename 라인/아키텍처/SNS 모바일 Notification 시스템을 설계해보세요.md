

```







알림 시스템(notification system)은 최근 많은 프로그램이 채택한 인기 있는 기능이다.
이 기능을 갖춘 애플리케이션 프로그램은 최신 뉴스, 제품 업데이트, 이벤트, 선물 등
고객에게 중요할 만한 정보를 비동기적으로 제공한다.

이 기능은 이미 우리 일상생활의 중요한 부분으로 자리 잡았다
이번 장에서는 바로 이 알림 시스템을 설계해볼 것이다.

알림 시스템은 단순히 모바일 푸시 알림(mobile push notification)에 한정되지 않는다
사실 알림 시스템은 모바일 푸시 알림, SMS 메시지, 그리고 이메일의 세 가지로 분류할 수 있다
 
그림 10-1에 각각의 예가 나와 있다


1단계) 문제 이해 및 설계 범위 확정
- 하루에 백만 건 이상의 알림을 처리하는 확장성 높은 시스템을 구축하는 게 쉬운 과제는 아니다
  알림 시스템이 어떻게 구현되는지에 대한 깊은 이해가 필요한 작업이다.
  이에 관한 문제가 면접에 출제될 때는 보통 정해진 정답이 없고 문제 자체가 모호하게 주어지는 것이 일반적이므로,
  적절한 질문을 통해 요구사항이 무엇인지 지원자 스스로 알아내야 한다.

지원자: 이 시스템은 어떤 종류의 알림을 지원해야 하나요?
면접관: 푸시 알림, SMS 메시지, 그리고 이메일입니다.
지원자: 실시간(real-time) 시스템이어야 하나요?
면접관: 연성 실시간(soft real-time) 시스템이라고 가정합니다. 
             알림은 가능한한 빨리 전달되어야 하지만, 시스템에 높은 부하가 걸렸을 때, 약간의 지연은 무방합니다.
지원자: 어떤 종류의 단말을 지원해야 하나요?
면접관: iOS 단말, 안드로이드(android) 단말, 그리고 랩톱/데스크톱을 지원해야 합니다.
지원자: 사용자에게 보낼 알림은 누가 만들 수 있나요?
면접관: 클라이언트 애플리케이션 프로그램이 만들 수도 있구요. 서버 측에서 스케줄링 할 수도 있습니다.
지원자: 사용자가 알림을 받지 않도록(opt-out) 설정할 수 도 있어야 하나요?
면접관: 네. 해당 설정을 마친 사용자는 더 이상 알림을 받지 않습니다.
지원자: 하루에 몇 건의 알림을 보낼 수 있어야 하나요?
면접관: 천만 건의 모바일 푸시 알림, 백만 건의 SMS 메시지, 5백만 건의 이메일을 보낼 수 있어야 합니다. 


2단계) 개략적 설계안 제시 및 동의 구하기
- 이번 절에서는 iOS 푸시 알림, 안드로이드 푸시 알림, SMS 메시지 그리고 이메일을 지원하는 알림 시스템의 개략적 설계안을 살펴볼 것이다.
  다음과 같은 내용을 다룬다.

(1) 알림 유형별 지원 방안
(2) 연락처 정보 수집 절차
(3) 알림 전송 및 수신 절차

(1) 알림 유형별 지원 방안
- 우선 각각의 알림 메커니즘이 어떻게 동작하는지부터 알아보자

1) iOS 푸시 알림
- iOS에서 푸시 알림을 보내기 위해서는 세 가지 컴포넌트가 필요하다

- 알림 제공자(provider): 알림 요청(notification request)을 만들어 애플 푸시 알림 서비스(APNS: Apple Push Notification Service)로 보내는 주체다.
                                       알림 요청을 만들려면 다음과 같은 데이터가 필요하다
(1) 단말 토큰(device token): 알림 요청을 보내는데 필요한 고유 식별자다
(2) 페이로드(payload): 알림 내용을 담은 JSON 딕셔너리(dictionary)다. 아래는 그 예다. 
{
  "aps": {
              "alert": {
                  "title": "Game Request",
                  "body":  "Bob wants to play chess",
                  "action-loc-key": "PLAY",
               },
              "badge": 5
          }
}

(3) APNS: 애플이 제공하는 원격 서비스다. 푸시 알림은 iOS 장치로 보내는 역할을 담당한다
(4) iOS 단말(iOS device): 푸시 알림을 수신하는 사용자 단말이다.

2) 안드로이드 푸시 알림
- 안드로이드 푸시 알림도 비슷한 절차로 전송된다. APNS 대신 FCM(Firebase Cloud Message)을 사용한다는 점만 다르다.

3) SMS 메시지
- SMS 메시지를 보낼 때는 보통 트윌리오, 넥스모 같은 제3자 사업자의 서비스를 많이 이용한다
  이런 서비스는 대부분 상용 서비스라서 이용요금을 내야 한다.

4) 이메일
- 대부분의 회사는 고유 이메일 서버를 구축할 역량은 갖추고 있다. 
  그럼에도 많은 회사가 상용 이메일 서비스를 이용한다.
   그중 유명한 서비스로 센드그리드, 메일침프가 있다.
   전송 성공률도 높고, 데이터 분석 서비스(analytics)도 제공한다.
  그림 10-6은 지금까지 살펴본 알림 유형 전부를 한 시스템으로 묶은 결과다. 

5) 연락처 정보 수집 절차
- 알림을 보내려면 모바일 단말 토큰, 전화번호, 이메일 주소 등의 정보가 필요하다.
  그림 10-7과 같이 사용자가 우리 앱을 설치하거나 처음으로 계정을 등록하면 API 서버는
  해당 사용자의 정보를 수집하여 데이터베이스에 저장한다. 

- 이 데이터베이스에 연락처 정보를 저장할 테이블 구조는 그림 10-8과 같다.
  필수 정보만 담은 개략적인 설계안으로서, 이메일 주소와 전화번호는 user 테이블에 저장하고,
  단말 토큰은 device 테이블에 저장한다.
  한 사용자가 여러 단말을 가질 수 있고, 알림은 모든 단말에 전송되어야 한다는 점을 고려하였다. 

6) 알림 전송 및 수신 절차
- 우선 개략적인 설계안부터 살펴보고, 점차로 최적화해 나가도록 할 것이다. 

그림 10-9는 개략적 설계 초안이다. 각 시스템 컴포넌트에 대한 설명은 그 아래에 두었다. 

(1) 1부터 N까지의 서비스
- 이 서비스 각각은 마이크로서비스(microservice)일 수도 있고,
  크론잡(cronjob)일 수도 있고, 분산 시스템 컴포넌트일 수도 있다.
  사용자에게 납기일을 알리고자 하는 과금 서비스(billing service), 배송 알림을 보내려는 쇼핑몰 웹사이트 등이 그 예다.

(2) 알림 시스템(notification system)
- 알림 시스템은 알림 전송/수신 처리의 핵심이다. 우선은 1개 서버만 사용하는 시스템이라고 가정해 보자.
  이 시스템은 서비스 1~N에 알림 전송을 위한 API를 제공해야 하고,
  제3자 서비스에 전달할 알림 페이로드(Payload)를 만들어 낼 수 있어야 한다. 

(3) 제3자 서비스(third party services)
-이 서비스들은 사용자에게 알림을 실제로 전달하는 역할을 한다.
 제3자 서비스와의 통합을 진행할 때 유의할 것은 확장성(extensibility)이다.
 쉽게 새로운 서비스를 통합하거나, 기존 서비스를 제거할 수 있어야 한다는 뜻이다.
 또 하나 고려해야 할 것은, 어떤 서비스는 다른 시장에서는 사용할 수 없을 수도 있다는 것이다.
 가령 FCM은 중국에서는 사용할 수 없다. 따라서 중국 시장에서는 제이푸시(Jpush), 푸시와이(PushY) 같은 서비스를 사용해야만 한다.

(4) iOS, 안드로이드, SMS, 이메일 단말
- 사용자는 자기 단말에서 알림을 수신한다.

- 이 설계에는 몇 가지 문제가 있다.
(1) SPOF(Single Point Of Failure)
- 알림 서비스에 서버가 하나밖에 없다는 것은, 그 서버에 장애가 생기면 전체 서비스의 장애로 이어진다는 뜻이다.
(2) 규모 확장성
- 한 대 서비스로 푸시 알림에 관계된 모든 것을 처리하므로, 데이터베이스나 캐시 등 중요 컴포넌트의 규모를 개별적으로 늘릴 방법이 없다.
(3) 성능 병목
- 알림을 처리하고 보내는 것은 자원을 많이 필요로 하는 작업일 수 있다.
  예를 들어, HTML 페이지를 만들고 제3자 서비스의 응답을 기다리는 일은




```
